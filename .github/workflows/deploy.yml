name: Deploy

on:
    workflow_dispatch:
        inputs:
            environment:
                description: "Target environment"
                required: true
                type: choice
                options:
                    - staging
                    - production
            version:
                description: "Version to deploy (e.g., v1.2.3 or sha-a1b2c3d)"
                required: true
                type: string

concurrency:
    group: deploy-${{ inputs.environment }}
    cancel-in-progress: false

env:
    REGISTRY: ghcr.io
    REPO: lyther/fkllmproxy

jobs:
    preflight:
        name: Pre-flight Checks
        runs-on: ubuntu-latest
        timeout-minutes: 5
        outputs:
            image_proxy: ${{ steps.images.outputs.proxy }}
            image_harvester: ${{ steps.images.outputs.harvester }}
            image_bridge: ${{ steps.images.outputs.bridge }}

        steps:
            - name: Build image names
              id: images
              run: |
                  echo "proxy=${{ env.REGISTRY }}/${{ env.REPO }}/vertex-bridge:${{ inputs.version }}" >> $GITHUB_OUTPUT
                  echo "harvester=${{ env.REGISTRY }}/${{ env.REPO }}/harvester:${{ inputs.version }}" >> $GITHUB_OUTPUT
                  echo "bridge=${{ env.REGISTRY }}/${{ env.REPO }}/anthropic-bridge:${{ inputs.version }}" >> $GITHUB_OUTPUT

            - name: Login to GHCR
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Verify images exist
              run: |
                  echo "ðŸ” Verifying images..."
                  docker manifest inspect ${{ steps.images.outputs.proxy }} || exit 1
                  docker manifest inspect ${{ steps.images.outputs.harvester }} || exit 1
                  docker manifest inspect ${{ steps.images.outputs.bridge }} || exit 1
                  echo "âœ… All images verified"

    deploy-staging:
        name: Deploy to Staging
        runs-on: ubuntu-latest
        needs: preflight
        if: inputs.environment == 'staging'
        timeout-minutes: 15
        environment:
            name: staging
            url: https://staging.fkllmproxy.example.com

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup kubectl
              uses: azure/setup-kubectl@v3

            - name: Configure kubeconfig
              run: |
                  mkdir -p ~/.kube
                  echo "${{ secrets.KUBE_CONFIG_STAGING }}" | base64 -d > ~/.kube/config
                  chmod 600 ~/.kube/config

            - name: Deploy
              run: |
                  echo "ðŸš€ Deploying to staging..."
                  kubectl set image deployment/fkllmproxy \
                    vertex-bridge=${{ needs.preflight.outputs.image_proxy }} \
                    -n default --record
                  kubectl set image deployment/fkllmproxy-harvester \
                    harvester=${{ needs.preflight.outputs.image_harvester }} \
                    -n default --record
                  kubectl set image deployment/fkllmproxy-anthropic-bridge \
                    anthropic-bridge=${{ needs.preflight.outputs.image_bridge }} \
                    -n default --record

            - name: Wait for rollout
              run: |
                  echo "â³ Waiting for rollout..."
                  kubectl rollout status deployment/fkllmproxy -n default --timeout=300s
                  kubectl rollout status deployment/fkllmproxy-harvester -n default --timeout=300s
                  kubectl rollout status deployment/fkllmproxy-anthropic-bridge -n default --timeout=300s

            - name: Verify health
              run: |
                  echo "ðŸ’“ Verifying health..."
                  sleep 10
                  kubectl get pods -n default -l app=fkllmproxy

            - name: Rollback on failure
              if: failure()
              run: |
                  echo "âŒ Deployment failed, rolling back..."
                  kubectl rollout undo deployment/fkllmproxy -n default || true
                  kubectl rollout undo deployment/fkllmproxy-harvester -n default || true
                  kubectl rollout undo deployment/fkllmproxy-anthropic-bridge -n default || true

    deploy-production:
        name: Deploy to Production
        runs-on: ubuntu-latest
        needs: preflight
        if: inputs.environment == 'production'
        timeout-minutes: 20
        environment:
            name: production
            url: https://fkllmproxy.example.com

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup kubectl
              uses: azure/setup-kubectl@v3

            - name: Configure kubeconfig
              run: |
                  mkdir -p ~/.kube
                  echo "${{ secrets.KUBE_CONFIG_PRODUCTION }}" | base64 -d > ~/.kube/config
                  chmod 600 ~/.kube/config

            - name: Deploy
              run: |
                  echo "ðŸš€ Deploying to production..."
                  kubectl set image deployment/fkllmproxy \
                    vertex-bridge=${{ needs.preflight.outputs.image_proxy }} \
                    -n default --record
                  kubectl set image deployment/fkllmproxy-harvester \
                    harvester=${{ needs.preflight.outputs.image_harvester }} \
                    -n default --record
                  kubectl set image deployment/fkllmproxy-anthropic-bridge \
                    anthropic-bridge=${{ needs.preflight.outputs.image_bridge }} \
                    -n default --record

            - name: Wait for rollout
              run: |
                  echo "â³ Waiting for rollout..."
                  kubectl rollout status deployment/fkllmproxy -n default --timeout=300s
                  kubectl rollout status deployment/fkllmproxy-harvester -n default --timeout=300s
                  kubectl rollout status deployment/fkllmproxy-anthropic-bridge -n default --timeout=300s

            - name: Verify health
              run: |
                  echo "ðŸ’“ Verifying health..."
                  sleep 10
                  kubectl get pods -n default -l app=fkllmproxy
                  # TODO: Add actual health endpoint check against production URL

            - name: Rollback on failure
              if: failure()
              run: |
                  echo "âŒ Deployment failed, rolling back..."
                  kubectl rollout undo deployment/fkllmproxy -n default || true
                  kubectl rollout undo deployment/fkllmproxy-harvester -n default || true
                  kubectl rollout undo deployment/fkllmproxy-anthropic-bridge -n default || true

    notify:
        name: Notify
        runs-on: ubuntu-latest
        needs: preflight
        if: always()

        steps:
            - name: Deployment summary
              run: |
                  echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
                  echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
                  echo "| Environment | ${{ inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Version | ${{ inputs.version }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Triggered by | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Preflight Status | ${{ needs.preflight.result }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Overall Status | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY

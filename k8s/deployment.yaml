apiVersion: apps/v1
kind: Deployment
metadata:
    name: fkllmproxy
    namespace: default
    labels:
        app: fkllmproxy
        component: proxy
spec:
    replicas: 2
    revisionHistoryLimit: 5
    strategy:
        type: RollingUpdate
        rollingUpdate:
            maxSurge: 1
            maxUnavailable: 0
    selector:
        matchLabels:
            app: fkllmproxy
            component: proxy
    template:
        metadata:
            labels:
                app: fkllmproxy
                component: proxy
        spec:
            securityContext:
                runAsNonRoot: true
                runAsUser: 1000
                fsGroup: 1000
                seccompProfile:
                    type: RuntimeDefault
            containers:
                - name: vertex-bridge
                  # WARNING: Pin to specific version in production (e.g., fkllmproxy:v1.0.2)
                  # Using :latest is discouraged for reproducible deployments
                  image: fkllmproxy:latest # TODO: Replace with ghcr.io/lyther/fkllmproxy/vertex-bridge:v1.x.x
                  imagePullPolicy: IfNotPresent
                  securityContext:
                      allowPrivilegeEscalation: false
                      readOnlyRootFilesystem: true
                      capabilities:
                          drop:
                              - ALL
                  ports:
                      - containerPort: 4000
                        name: http
                        protocol: TCP
                  env:
                      - name: APP_SERVER__HOST
                        value: "0.0.0.0"
                      - name: APP_SERVER__PORT
                        value: "4000"
                      - name: APP_LOG__LEVEL
                        value: "info"
                      - name: APP_LOG__FORMAT
                        value: "json"
                      - name: APP_AUTH__REQUIRE_AUTH
                        value: "true"
                      - name: APP_AUTH__MASTER_KEY
                        valueFrom:
                            secretKeyRef:
                                name: fkllmproxy-secrets
                                key: master-key
                      - name: APP_VERTEX__PROJECT_ID
                        valueFrom:
                            configMapKeyRef:
                                name: fkllmproxy-config
                                key: vertex-project-id
                      - name: APP_VERTEX__REGION
                        valueFrom:
                            configMapKeyRef:
                                name: fkllmproxy-config
                                key: vertex-region
                      - name: GOOGLE_APPLICATION_CREDENTIALS
                        value: "/etc/gcp/sa.json"
                      - name: APP_OPENAI__HARVESTER_URL
                        value: "http://fkllmproxy-harvester:3001"
                      - name: APP_ANTHROPIC__BRIDGE_URL
                        value: "http://fkllmproxy-anthropic-bridge:4001"
                  volumeMounts:
                      - name: gcp-credentials
                        mountPath: /etc/gcp
                        readOnly: true
                      - name: tmp
                        mountPath: /tmp
                  resources:
                      requests:
                          memory: "256Mi"
                          cpu: "100m"
                      limits:
                          memory: "512Mi"
                          cpu: "500m"
                  livenessProbe:
                      httpGet:
                          path: /health
                          port: 4000
                      initialDelaySeconds: 30
                      periodSeconds: 10
                      timeoutSeconds: 5
                      failureThreshold: 3
                  readinessProbe:
                      httpGet:
                          path: /health
                          port: 4000
                      initialDelaySeconds: 10
                      periodSeconds: 5
                      timeoutSeconds: 3
                      failureThreshold: 3
            volumes:
                - name: gcp-credentials
                  secret:
                      secretName: fkllmproxy-gcp-credentials
                - name: tmp
                  emptyDir:
                      sizeLimit: 100Mi
---
apiVersion: apps/v1
kind: Deployment
metadata:
    name: fkllmproxy-harvester
    namespace: default
    labels:
        app: fkllmproxy
        component: harvester
spec:
    replicas: 1
    revisionHistoryLimit: 5
    strategy:
        type: RollingUpdate
        rollingUpdate:
            maxSurge: 1
            maxUnavailable: 0
    selector:
        matchLabels:
            app: fkllmproxy
            component: harvester
    template:
        metadata:
            labels:
                app: fkllmproxy
                component: harvester
        spec:
            securityContext:
                runAsNonRoot: true
                runAsUser: 1000
                fsGroup: 1000
                seccompProfile:
                    type: RuntimeDefault
            containers:
                - name: harvester
                  # WARNING: Pin to specific version in production (e.g., fkllmproxy-harvester:v1.0.2)
                  image: fkllmproxy-harvester:latest # TODO: Replace with ghcr.io/lyther/fkllmproxy/harvester:v1.x.x
                  imagePullPolicy: IfNotPresent
                  securityContext:
                      allowPrivilegeEscalation: false
                      readOnlyRootFilesystem: true
                      capabilities:
                          drop:
                              - ALL
                  ports:
                      - containerPort: 3001
                        name: http
                        protocol: TCP
                  env:
                      - name: PORT
                        value: "3001"
                      - name: HOST
                        value: "0.0.0.0"
                      - name: NODE_ENV
                        value: "production"
                      - name: PLAYWRIGHT_BROWSERS_PATH
                        value: "/app/.cache/ms-playwright"
                  volumeMounts:
                      - name: tmp
                        mountPath: /tmp
                      - name: playwright-cache
                        mountPath: /app/.cache
                      - name: cookies
                        mountPath: /app/cookies.json
                        subPath: cookies.json
                  resources:
                      requests:
                          memory: "512Mi"
                          cpu: "200m"
                      limits:
                          memory: "1Gi"
                          cpu: "1000m"
                  livenessProbe:
                      httpGet:
                          path: /health
                          port: 3001
                      initialDelaySeconds: 60
                      periodSeconds: 30
            volumes:
                - name: tmp
                  emptyDir:
                      sizeLimit: 100Mi
                - name: playwright-cache
                  emptyDir:
                      sizeLimit: 500Mi
                - name: cookies
                  emptyDir:
                      sizeLimit: 1Mi
---
apiVersion: apps/v1
kind: Deployment
metadata:
    name: fkllmproxy-anthropic-bridge
    namespace: default
    labels:
        app: fkllmproxy
        component: anthropic-bridge
spec:
    replicas: 1
    revisionHistoryLimit: 5
    strategy:
        type: RollingUpdate
        rollingUpdate:
            maxSurge: 1
            maxUnavailable: 0
    selector:
        matchLabels:
            app: fkllmproxy
            component: anthropic-bridge
    template:
        metadata:
            labels:
                app: fkllmproxy
                component: anthropic-bridge
        spec:
            securityContext:
                runAsNonRoot: true
                runAsUser: 1000
                fsGroup: 1000
                seccompProfile:
                    type: RuntimeDefault
            containers:
                - name: anthropic-bridge
                  # WARNING: Pin to specific version in production (e.g., fkllmproxy-anthropic-bridge:v1.0.2)
                  image: fkllmproxy-anthropic-bridge:latest # TODO: Replace with ghcr.io/lyther/fkllmproxy/anthropic-bridge:v1.x.x
                  imagePullPolicy: IfNotPresent
                  securityContext:
                      allowPrivilegeEscalation: false
                      readOnlyRootFilesystem: true
                      capabilities:
                          drop:
                              - ALL
                  ports:
                      - containerPort: 4001
                        name: http
                        protocol: TCP
                  env:
                      - name: PORT
                        value: "4001"
                      - name: HOST
                        value: "0.0.0.0"
                      - name: NODE_ENV
                        value: "production"
                  volumeMounts:
                      - name: tmp
                        mountPath: /tmp
                  resources:
                      requests:
                          memory: "128Mi"
                          cpu: "100m"
                      limits:
                          memory: "256Mi"
                          cpu: "500m"
                  livenessProbe:
                      httpGet:
                          path: /health
                          port: 4001
                      initialDelaySeconds: 30
                      periodSeconds: 30
            volumes:
                - name: tmp
                  emptyDir:
                      sizeLimit: 100Mi
